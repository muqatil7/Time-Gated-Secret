<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>إنشاء / تعديل صفحة HTML</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/public/styles.css" />
</head>
<body class="min-h-screen antialiased">
  <nav class="sticky top-0 w-full py-3 px-6 bg-slate-800 border-b border-indigo-700 shadow flex items-center justify-between z-10">
    <div>
      <a href="/html/list" class="text-indigo-300 px-3 py-2 hover:bg-slate-700 rounded transition text-lg font-bold">عرض الصفحات</a>
      <a href="/html" class="text-yellow-400 px-3 py-2 hover:bg-yellow-200 rounded transition text-lg font-bold">إنشاء / تعديل صفحة</a>
    </div>
  </nav>
  <main class="max-w-3xl mx-auto my-7 p-6 card shadow-xl">
    <!-- رسالة الحالة -->
    <div id="status-message" class="hidden mb-4 p-4 rounded-md text-center"></div>
    
    <header role="banner" class="mb-6">
      <h1 id="page-title" class="text-3xl font-bold mb-2">إنشاء صفحة HTML جديدة</h1>
      <p class="text-slate-400 mb-4">اسحب ملف HTML، أو أدخل اسما جديدا وابدأ بالحفظ أو التعديل.</p>
    </header>
    <form id="html-form" class="space-y-4">
      <div>
        <label class="block text-sm font-medium mb-1" for="page_name">اسم الصفحة</label>
        <input id="page_name" name="page_name" pattern="^[a-zA-Z0-9_-]{3,32}$" autocomplete="off" required class="w-full rounded-md border px-3 py-2 mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="ادخل اسم الصفحة...">
      </div>
      <div>
        <label class="block text-sm font-medium mb-1" for="html_code">كود HTML</label>
        <textarea id="html_code" name="html_code" rows="10" required class="w-full rounded-md border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="اسحب ملف HTML هنا أو الصق الكود..."></textarea>
        <div id="drop-zone" class="mt-3 p-5 border border-dashed border-primary rounded bg-slate-900 text-slate-200 text-center cursor-pointer select-none">قم بسحب ملف HTML هنا لإسقاطه</div>
      </div>
      <section class="flex flex-row-reverse gap-3 mt-4">
        <button type="button" id="save-firebase-btn" class="inline-flex items-center justify-center rounded-md bg-green-600 px-4 py-2 text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 transition disabled:opacity-60 disabled:cursor-not-allowed" autocomplete="off">
          <svg id="save-svg" class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
          <span>حفظ</span>
        </button>
        <button type="button" id="preview-btn" class="inline-flex items-center justify-center rounded-md bg-blue-600 px-4 py-2 text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
          <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
          <span>عرض</span>
        </button>
      </section>
    </form>
  </main>
  <script>
    const dropZone = document.getElementById('drop-zone');
    const textarea = document.getElementById('html_code');
    const pageNameInput = document.getElementById('page_name');
    const saveFirebaseBtn = document.getElementById('save-firebase-btn');
    const statusMessage = document.getElementById('status-message');
    const previewBtn = document.getElementById('preview-btn');
    const pageTitle = document.getElementById('page-title');

    function checkInputs() {
      saveFirebaseBtn.disabled = !(pageNameInput.value.trim() && textarea.value.trim());
    }

    pageNameInput.addEventListener('input', checkInputs);
    textarea.addEventListener('input', checkInputs);

    function showMessage(msg, type = 'success') {
      statusMessage.textContent = msg;
      statusMessage.className = `mb-4 p-4 rounded-md text-center ${type === 'success' ? 'bg-green-100 text-green-800 border border-green-300' : 'bg-red-100 text-red-800 border border-red-300'}`;
      statusMessage.classList.remove('hidden');
      setTimeout(() => statusMessage.classList.add('hidden'), 5000);
    }

    dropZone.addEventListener('dragover', e => {
      e.preventDefault();
      dropZone.classList.add('bg-primary','text-indigo-100');
    });

    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('bg-primary','text-indigo-100'));

    dropZone.addEventListener('drop', e => {
      e.preventDefault();
      dropZone.classList.remove('bg-primary','text-indigo-100');
      const file = e.dataTransfer.files[0];
      if (file && file.type === "text/html") {
        const reader = new FileReader();
        reader.onload = ev => {
          textarea.value = ev.target.result;
          checkInputs();
        };
        reader.readAsText(file);
      } else {
        showMessage('يرجى إسقاط ملف HTML صحيح فقط', 'error');
      }
    });

    saveFirebaseBtn.addEventListener('click', async () => {
      if(saveFirebaseBtn.disabled) return;
      const pageName = pageNameInput.value.trim();
      const htmlCode = textarea.value.trim();

      saveFirebaseBtn.querySelector('span').textContent = 'جاري الحفظ...';
      saveFirebaseBtn.disabled = true;

      try {
        const res = await fetch('/html/save', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ page_name: pageName, html_code: htmlCode })
        });
        const data = await res.json();
        if(data.success) {
          showMessage(data.message,'success');
          // Redirect to the list page after successful save
          setTimeout(() => {
            window.location.href = '/html/list';
          }, 1500);
        } else {
          showMessage(data.message || 'لم يتم الحفظ!','error');
        }
      } catch(err) {
        showMessage('خطأ في الاتصال بالخادم','error');
      } finally {
        saveFirebaseBtn.querySelector('span').textContent = 'حفظ';
        checkInputs();
      }
    });

    previewBtn.addEventListener('click', () => {
      const htmlCode = textarea.value.trim();
      if (!htmlCode) return showMessage('أدخل كود HTML للمعاينة','error');
      const previewWindow = window.open('', '_blank');
      previewWindow.document.write(htmlCode);
      previewWindow.document.close();
    });

    async function loadPageForEditing(pageName) {
      try {
        const response = await fetch(`/html/pages/${pageName}/edit`);
        const data = await response.json();
        if(data.success) {
          pageNameInput.value = data.page.name;
          textarea.value = data.page.htmlCode;
          pageTitle.textContent = `تعديل الصفحة: ${data.page.name}`;
          pageNameInput.readOnly = true; // Prevent editing of page name
          checkInputs();
        } else {
            showMessage(data.message || 'فشل تحميل الصفحة', 'error');
        }
      } catch {
        showMessage('فشل تحميل الصفحة', 'error');
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const pageToEdit = urlParams.get('page');
      if (pageToEdit) {
        loadPageForEditing(pageToEdit);
      }
      checkInputs();
    });
  </script>
</body>
</html>
